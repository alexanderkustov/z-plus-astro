---
import "../styles/global.css";
import ThemeToggle from "../components/ThemeToggle.astro";

import { SEO } from "astro-seo";

const {
  title = "Z+",
  description = "Join the future of connectivity with Z+",
  image = "/og-image.png",
  share = {},
} = Astro.props;

const siteUrl = Astro.site || "https://z-plus.co.uk";
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).toString();
const shareTitle = share.title ?? title;
const shareDescription = share.description ?? description;
const shareLink = share.link
  ? new URL(share.link, siteUrl).toString()
  : canonicalUrl;
const shareImage = new URL(share.image ?? image, siteUrl).toString();
const sharePayload = {
  title: shareTitle,
  description: shareDescription,
  link: shareLink,
  image: shareImage,
};
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SEO
      title={title}
      description={description}
      openGraph={{
        basic: {
          title: title,
          type: "website",
          image: new URL(
            image,
            siteUrl,
          ).toString(),
        },
        optional: {
          description: description,
        },
      }}
      twitter={{
        card: "summary_large_image",
      }}
      extend={{
        link: [
          { rel: "icon", href: "/favicon.svg" },
          { rel: "canonical", href: canonicalUrl },
        ],
        meta: [
          { name: "robots", content: "index,follow" },
          { name: "googlebot", content: "index,follow,max-image-preview:large" },
          { name: "theme-color", content: "#111827" },
          { property: "og:site_name", content: "Z+" },
          { property: "og:locale", content: "en_GB" },
          {
            name: "twitter:image",
            content: new URL(
              image,
              siteUrl,
            ).toString(),
          },
          { name: "twitter:description", content: description },
        ],
      }}
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap"
    />
    <script is:inline>
      const storedTheme = localStorage.getItem("theme");
      const systemPrefersDark = window.matchMedia?.(
        "(prefers-color-scheme: dark)",
      ).matches;
      const resolvedTheme =
        storedTheme ?? (systemPrefersDark ? "dark" : "light");
      document.documentElement.dataset.theme = resolvedTheme;
    </script>
    <script is:inline>
      const sharePayload = ${JSON.stringify(sharePayload)};
      const isWeChatBrowser = /MicroMessenger/i.test(navigator.userAgent);
      const applyWeChatShareData = async () => {
        if (!window.wx) {
          console.warn("WeChat JS-SDK unavailable.");
          return;
        }

        try {
          const response = await fetch(
            `/api/wechat-signature?url=${encodeURIComponent(
              window.location.href.split("#")[0],
            )}`,
          );
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload?.error || "Failed to load WeChat signature.");
          }

          window.wx.config({
            debug: false,
            appId: payload.appId,
            timestamp: payload.timestamp,
            nonceStr: payload.nonceStr,
            signature: payload.signature,
            jsApiList: [
              "updateAppMessageShareData",
              "updateTimelineShareData",
            ],
          });

          window.wx.ready(() => {
            window.wx.updateAppMessageShareData({
              title: sharePayload.title,
              desc: sharePayload.description,
              link: sharePayload.link,
              imgUrl: sharePayload.image,
            });
            window.wx.updateTimelineShareData({
              title: sharePayload.title,
              link: sharePayload.link,
              imgUrl: sharePayload.image,
            });
          });

          window.wx.error((error) => {
            console.warn("WeChat JS-SDK config error:", error);
          });
        } catch (error) {
          console.warn("WeChat share setup failed:", error);
        }
      };

      if (isWeChatBrowser) {
        const sdkScript = document.createElement("script");
        sdkScript.src = "https://res.wx.qq.com/open/js/jweixin-1.6.0.js";
        sdkScript.async = true;
        sdkScript.onload = applyWeChatShareData;
        sdkScript.onerror = () => {
          console.warn("Failed to load WeChat JS-SDK script.");
        };
        document.head.appendChild(sdkScript);
      }
    </script>
  </head>
  <body>
    <header>
      <div class="site-header">
        <a class="brand" href="/">Z+</a>
        <nav aria-label="Main">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/about">About Us</a></li>
            <li><a href="/services">Services</a></li>
            <li><a href="/case-studies">Case Studies</a></li>
          </ul>
        </nav>
        <ThemeToggle />
      </div>
    </header>
    <main>
      <slot />
      <footer class="site-footer">
        <p class="footer-main">
          Contact us:
          <a
            class="email-link"
            data-email-user="info"
            data-email-domain="z-plus.co.uk"
            data-email-text="true"
            >Email us</a
          >
        </p>
        <p class="footer-copy">© 2016–2024 Z+ Limited</p>
        <p class="footer-legal">
          Z+ Limited is registered in England and Wales (No. 09941671). <a
            href="#"
            rel="noopener">Privacy Policy</a
          >
        </p>
      </footer>
    </main>
    <script is:inline>
      const emailLinks = document.querySelectorAll(".email-link");
      emailLinks.forEach((link) => {
        const user = link.dataset.emailUser;
        const domain = link.dataset.emailDomain;
        if (!user || !domain) return;
        const address = `${user}@${domain}`;
        link.href = `mailto:${address}`;
        if (link.dataset.emailText === "true") {
          link.textContent = address;
        }
      });
    </script>
  </body>
</html>
